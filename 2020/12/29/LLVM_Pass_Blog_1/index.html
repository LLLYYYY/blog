<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>The road to LLVM pass (Part I) | Yu Liang's Blog</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/blog/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">The road to LLVM pass (Part I)</h1><a id="logo" href="/blog/.">Yu Liang's Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/blog/."><i class="fa fa-home"> Home</i></a><a href="/blog/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/blog/about/"><i class="fa fa-user"> About</i></a><a href="/blog/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">The road to LLVM pass (Part I)</h1><div class="post-meta">2020-12-29<span> | </span><span class="category"><a href="/blog/categories/LLVM/">LLVM</a></span></div><div class="post-content"><p>LLVM pass framework is one of the most important and fundamental elements in the LLVM system. While a program is compiling, passes will be applied to perform any code transformation, code optimization and code analysis works. However, the official LLVM document does not mention a lot of important details of writing a working pass for the LLVM system. Therefore, this blog will work as a reference for my own experience of how to write a fully functional LLVM pass.</p>
<p>The blog will be divided into three parts, Part I of the blog will introduce a way to implement the most easy dynamic loaded pass. Beginning from the second blog, we will introduce the way to statically link the pass <strong>into</strong> the LLVM library, to be able to run your LLVM pass as a default optimization step in the LLVM pipeline. Furthermore, you can even implement your LLVM pass to be able to run at <strong>Linking time</strong>. These kinds of passes that run at link time are also being referred as LTO(Link Time Optimization) pass. And LTO-passes currently can only be implemented by statically linked into the LLVM library(currently latest LLVM 12.0.0), knowing how to statically link your pass into the LLVM library can be very important. At last, since the new PassManager Passes API has been officially exposed and used in the LLVM system, we will introduce both the Legacy PassManager interface (Part II of the blog) and the new PassManager Pass interface (Part III of the blog). Let us begin the journey!</p>
<hr>
<h2 id="Writing-a-dynamic-loaded-pass-Legacy-PassManager"><a href="#Writing-a-dynamic-loaded-pass-Legacy-PassManager" class="headerlink" title="Writing a dynamic loaded pass. (Legacy PassManager)"></a>Writing a dynamic loaded pass. (Legacy PassManager)</h2><h3 id="Compile-LLVM"><a href="#Compile-LLVM" class="headerlink" title="Compile LLVM"></a>Compile LLVM</h3><p>First of all, download and install the LLVM system. In this blog, we are using version LLVM-9.0.0. We suggest you to download the LLVM system from the official llvm.org, or from the <a href="https://github.com/llvm/llvm-project">Github repo</a>. Remember to check the correct releases&#x2F;commits when you are using the git version of the source code. </p>
<p>Assuming we are working on the Linux machine (or possibly MacOS), to compile the LLVM system, go to the &#x2F;llvm sub folder, and create a new build folder. Use the <strong>cmake</strong> command to generate the make file. And then directly call <strong>make</strong> to compile.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./llvm</span><br><span class="line"><span class="built_in">mkdir</span> -p build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_PROJECTS=<span class="string">&quot;clang;clang-tools-extra;lld&quot;</span> -G <span class="string">&quot;Unix Makefiles&quot;</span> ../</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>Note that you should manually enables the LLVM projects that you want to compile, in this case, we are compiling clang, clang-tools-extra, and the LLVM linker lld. The complete list of these projects are: <strong>clang;clang-tools-extra;compiler-rt;debuginfo-tests;libc;libclc;libcxx;libcxxabi;libunwind;lld;lldb;openmp;parallel-libs;polly;pstl</strong>. Compile just what you need, and the compilation time will be pretty long…</p>
<h3 id="Dynamic-loaded-pass-Legacy-PassManager"><a href="#Dynamic-loaded-pass-Legacy-PassManager" class="headerlink" title="Dynamic loaded pass. (Legacy PassManager)"></a>Dynamic loaded pass. (Legacy PassManager)</h3><p>Writing a dynamic loaded pass that can be directly called by <strong>clang</strong> is straightfoward and easy. I will recommend reading the official LLVM document first. <a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#introduction-what-is-a-pass">Official Document Link.</a> Note that the official document is implementing the pass using cmake, and they place the pass file into the LLVM system. However, this is not mandatory. As an easy to implement pass, we place the pass source file anywhere we want in the file system, we can call clang to load it anytime as we required.</p>
<p>Next, let us create and write at the pass source file:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File MyPass.cc</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Module.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">MyPass</span> : <span class="keyword">public</span> ModulePass &#123;</span><br><span class="line">      <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">      <span class="built_in">MyPass</span>() : <span class="built_in">ModulePass</span>(ID) &#123;&#125;</span><br><span class="line">      <span class="function"><span class="type">bool</span> <span class="title">runOnModule</span><span class="params">(Module &amp;M)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Do whatever you want for the pass in this section.</span></span><br><span class="line">            <span class="comment">/* // Example BasicBlock IRBuilder syntax.</span></span><br><span class="line"><span class="comment">            for (auto &amp;F : M)&#123;  // Extract Function from Module</span></span><br><span class="line"><span class="comment">                for (auto &amp;BB : F) &#123;  //Extract BasicBlock from Function</span></span><br><span class="line"><span class="comment">                    BasicBlock::iterator IP = BB.getFirstInsertionPt();</span></span><br><span class="line"><span class="comment">                    IRBuilder&lt;&gt; IRB(&amp;(*IP));</span></span><br><span class="line"><span class="comment">                    // IRB.CreateLoad();</span></span><br><span class="line"><span class="comment">                    // IRB.CreateStone();</span></span><br><span class="line"><span class="comment">                    // ............</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125; */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// Not performing any transformation for the IR.</span></span><br><span class="line">            &#125;</span><br><span class="line">    &#125;; <span class="comment">// end of struct Hello</span></span><br><span class="line">&#125;  <span class="comment">// end of anonymous namespace</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> MyPass::ID = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;MyPass&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;My Pass&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="literal">false</span> <span class="comment">/* Only looks at CFG */</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="literal">false</span> <span class="comment">/* Analysis Pass */</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">Y</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">    [](<span class="type">const</span> PassManagerBuilder &amp;Builder,</span></span></span><br><span class="line"><span class="params"><span class="function">       legacy::PassManagerBase &amp;PM) &#123; PM.add(<span class="keyword">new</span> MyPass()); &#125;)</span></span>;</span><br></pre></td></tr></table></figure>

<p>To implement your own pass, we have to derive our pass struct from one of the following struct: ModulePass, FunctionPass, LoopPass and RegionPass. The most commonly used passes are ModulePass and FunctionPass, but you can choose based on what you need. The ModulePass and also extract and use Function level passes. Next, we override the <strong>runOn&lt;Module, Function, etc&gt;</strong> function. This is the main function that we used to implement your logic for your pass. The return value for this function is a bool value, return <code>true</code> if you have modified the IR, otherwise <code>false</code>. At last, we have to register the pass. Use <code>RegisterPass&lt;Hello&gt; X</code> to register the pass, or we can use <code>RegisterStandardPasses</code> to register our pass to the existing pipeline. All the possible Extension points are: <code>EP_EarlyAsPossible, EP_ModuleOptimizerEarly, EP_LoopOptimizerEnd, EP_ScalarOptimizerLate, EP_OptimizerLast, EP_VectorizerStart, EP_EnabledOnOptLevel0, EP_Peephole, EP_LateLoopOptimizations, EP_CGSCCOptimizerLate, EP_FullLinkTimeOptimizationEarly, EP_FullLinkTimeOptimizationLast</code> However, <code>EP_FullLinkTimeOptimizationEarly, EP_FullLinkTimeOptimizationLast</code> doesn’t seems to work correctly (LLVM-12.0.0), since I failed to call the pass in LTO using this register pipeline. Maybe they are values for future features. </p>
<p>After finishing the source file, we can use clang to compile it as a shared library. The command is:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -O3 -funroll-loops -Wall -D_FORTIFY_SOURCE=2 -g -Wno-pointer-sign -fPIC -c MyPass.cc -o MyPass.o</span><br></pre></td></tr></table></figure>

<p>Then we can load the pass by using clang!</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -Xclang -load -Xclang ./MyPass.o ./MyRandomCFile -o MyRandomCFile.o</span><br></pre></td></tr></table></figure>

<p>Check!</p>
</div><div class="tags"><a href="/blog/tags/blogs"><i class="fa fa-tag">blogs</i></a></div><div class="post-nav"><a class="pre" href="/blog/2022/08/15/python_profiling/">python profiling</a><a class="next" href="/blog/2020/12/29/LLVM_Pass_Blog_2/">The road to LLVM pass (Part II)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://github.com/SteveLeungYL/blog"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="About"><img src="/blog/img/avatar.png"/></a><p>To be a better man.</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:admin@domain.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Fuzzer/">Fuzzer</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/General/">General</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/LLVM/">LLVM</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Programming-Language/">Programming_Language</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/blog/tags/random-notes/" style="font-size: 15px;">random_notes</a> <a href="/blog/tags/blogs/" style="font-size: 15px;">blogs</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2022/10/17/delete_file_in_git_history/">Recursively delete files/folders in git history</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2022/10/01/Run%20sudo%20without%20password/">Run `SUDO` without password</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2022/09/08/PDF_check_font/">PDF check font</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2022/08/15/python_profiling/">python profiling</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2020/12/29/LLVM_Pass_Blog_1/">The road to LLVM pass (Part I)</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2020/12/29/LLVM_Pass_Blog_2/">The road to LLVM pass (Part II)</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2020/12/29/LLVM_Pass_Blog_3/">The road to LLVM pass (Part III)</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2020/12/17/The_road_to_modern_C++/">The road to modern C++</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2020/12/04/How_to_read_papers/">How to read papers</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2020/11/30/AFL_note/">AFL_Note</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/blog/." rel="nofollow">Yu Liang's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/blog/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/blog/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/blog/js/copycode.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/blog/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=1.0.0"></script></div></body></html>